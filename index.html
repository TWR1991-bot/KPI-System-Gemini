<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工考核系統 - 專業版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 配置檢查 ---
        let firebaseConfig = {};
        let appId = 'staff-eval-v1';

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
            if (typeof __app_id !== 'undefined' && __app_id) {
                appId = __app_id;
            }
        } catch (e) {
            console.error("Firebase config parsing error:", e);
        }
        
        // 只有在 config 存在時才初始化
        let app, auth, db;
        if (firebaseConfig.apiKey) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.error("Firebase configuration is missing or invalid.");
        }

        // --- 全域變數 ---
        let currentUser = null;
        let allUsers = [];
        let allRatings = [];
        let allTemplates = {}; 
        let activeView = 'login'; 
        let activeAdminTab = 'personnel';
        let currentMonth = "";
        let templateEditTargetId = 'default';
        
        const QUARTERLY_MONTHS = [3, 5, 9, 12];
        const RANKS = ['L1', 'L2', 'L3', 'L4', 'L5'];

        // --- 初始化邏輯 ---
        window.onload = () => {
            updateMonthDisplay();
            
            // 安全機制：如果 8 秒後還在轉圈圈，強制顯示頁面以便查看錯誤
            setTimeout(() => {
                const loader = document.getElementById('loading-overlay');
                if (loader && !loader.classList.contains('hidden')) {
                    console.warn("Loading safety timeout triggered.");
                    hideLoading();
                    if (!firebaseConfig.apiKey) {
                        showNotification("找不到資料庫設定，請檢查環境變數。", "error");
                    }
                }
            }, 8000);

            if (!auth) {
                hideLoading();
                return;
            }

            const authenticate = async (retryCount = 0) => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    if (retryCount < 3) {
                        setTimeout(() => authenticate(retryCount + 1), (retryCount + 1) * 1000);
                    } else {
                        console.error("Auth failed after retries:", e);
                        hideLoading();
                        showNotification("連線伺服器失敗，請檢查網路狀態。", "error");
                    }
                }
            };
            authenticate();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        await ensureAdminExists();
                        startDataListeners();
                    } catch (err) {
                        console.error("Init data error:", err);
                    }
                    hideLoading();
                }
            });
        };

        async function ensureAdminExists() {
            if (!db) return;
            const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', 'Admin01');
            const snap = await getDoc(adminRef);
            if (!snap.exists()) {
                await setDoc(adminRef, {
                    id: 'Admin01', name: '系統管理員', password: '76380260',
                    role: 'admin', type: 'supervisor', rank: 'L5', supervisorIds: []
                });
            } else if (snap.data().rank !== 'L5') {
                await updateDoc(adminRef, { rank: 'L5' });
            }
        }

        function startDataListeners() {
            if (!db) return;
            // 監聽使用者
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderLoginSelect();
                if (activeView === 'supervisor') renderSupervisorDashboard();
                if (activeView === 'admin' && activeAdminTab === 'personnel') renderPersonnelTab();
                if (activeView === 'admin' && activeAdminTab === 'template') renderTemplateTab();
            });

            // 監聽評分
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'ratings'), (snap) => {
                allRatings = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (activeView === 'supervisor') renderSupervisorDashboard();
                if (activeView === 'admin') {
                    if (activeAdminTab === 'stats') renderStatsTab();
                    if (activeAdminTab === 'charts') renderChartsTab();
                }
            });

            // 監聽模板
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'templates'), (snap) => {
                allTemplates = {};
                snap.docs.forEach(d => { allTemplates[d.id] = d.data(); });
                if (!allTemplates['default']) initDefaultTemplate();
                if (activeView === 'admin' && activeAdminTab === 'template') renderTemplateTab();
            });
        }

        async function initDefaultTemplate() {
            const defaultT = {
                work: [
                    { id: 'w1', name: '業務執行', weight: 50, items: [{ id: 'w1i1', name: '目標達成率' }] },
                    { id: 'w2', name: '品質控管', weight: 50, items: [{ id: 'w2i1', name: '錯誤率' }] }
                ],
                general: [
                    { id: 'g1', name: '團隊協作', weight: 100, items: [{ id: 'g1i1', name: '溝通能力' }] }
                ],
                learning: { weight: 20, items: [{ id: 'l1', name: '證照與進修' }] }
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'templates', 'default'), defaultT);
        }

        // --- UI Utils ---
        function hideLoading() { 
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                loader.classList.add('opacity-0');
                setTimeout(() => loader.classList.add('hidden'), 500);
            }
        }

        function updateMonthDisplay() {
            const now = new Date();
            currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.querySelectorAll('.current-month-text').forEach(el => el.innerText = currentMonth);
        }

        function renderLoginSelect() {
            const select = document.getElementById('login-user-select');
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '<option value="">請選擇帳號...</option>';
            allUsers.filter(u => u.type === 'supervisor').forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.innerText = `${u.name} (${u.role === 'admin' ? '管理員' : '主管'})`;
                select.appendChild(opt);
            });
            select.value = currentVal;
        }
        
        window.login = () => {
            const id = document.getElementById('login-user-select').value;
            const pass = document.getElementById('login-password').value;
            const user = allUsers.find(u => u.id === id && u.password === pass);
            if (user) {
                currentUser = user;
                activeView = 'supervisor';
                switchView();
                renderSupervisorDashboard();
                showNotification("登入成功", "success");
            } else { showNotification("帳號或密碼錯誤", "error"); }
        };

        function switchView() {
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${activeView}-view`).classList.remove('hidden');
            const mainNav = document.getElementById('main-nav');
            if (activeView === 'login') mainNav.classList.add('hidden');
            else {
                mainNav.classList.remove('hidden');
                document.getElementById('user-name-display').innerText = currentUser.name;
                const toggleBtn = document.getElementById('admin-toggle-btn');
                if (currentUser.role === 'admin') {
                    toggleBtn.classList.remove('hidden');
                    toggleBtn.innerText = activeView === 'admin' ? "返回評分端" : "進入管理端";
                } else toggleBtn.classList.add('hidden');
            }
            lucide.createIcons();
        }

        window.toggleAdminView = () => {
            activeView = activeView === 'admin' ? 'supervisor' : 'admin';
            switchView();
            if (activeView === 'admin') renderAdminTab();
            else renderSupervisorDashboard();
        };

        // --- 評分核心 ---
        function renderSupervisorDashboard() {
            const container = document.getElementById('employee-list');
            container.innerHTML = '';
            const myEmps = allUsers.filter(u => u.supervisorIds && Array.isArray(u.supervisorIds) && u.supervisorIds.includes(currentUser.id));
            const mInt = new Date().getMonth() + 1;

            if (myEmps.length === 0) container.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400 font-bold">目前沒有分配受評員工給您</div>`;

            myEmps.forEach(emp => {
                const isL5 = emp.rank === 'L5';
                const isEligible = !isL5 && (emp.rank === 'L1' || QUARTERLY_MONTHS.includes(mInt));
                const rating = allRatings.find(r => r.employeeId === emp.id && r.supervisorId === currentUser.id && r.month === currentMonth);
                const status = rating ? rating.status : 'none';
                
                const card = document.createElement('div');
                card.className = `p-6 bg-white rounded-[2rem] border ${!isEligible ? 'opacity-50 grayscale bg-slate-50' : 'border-slate-100 shadow-sm hover:shadow-xl transition-all'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-blue-600/10 rounded-2xl text-blue-600 shadow-inner"><i data-lucide="user"></i></div>
                        <span class="text-[10px] px-2.5 py-1 rounded-full font-black uppercase tracking-wider ${isL5 ? 'bg-slate-200 text-slate-500' : (status === 'submitted' ? 'bg-green-100 text-green-700' : status === 'draft' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500')}">
                            ${isL5 ? '免評對象' : (status === 'submitted' ? '已送出' : status === 'draft' ? '暫存中' : '未開始')}
                        </span>
                    </div>
                    <h3 class="text-xl font-black text-slate-800">${emp.name}</h3>
                    <p class="text-slate-400 font-bold text-xs mb-5">職等: ${emp.rank}</p>
                    <button ${!isEligible ? 'disabled' : ''} onclick="openEvaluation('${emp.id}')" class="w-full py-3 rounded-2xl font-black flex items-center justify-center gap-2 transition-all ${!isEligible ? 'bg-slate-100 text-slate-400' : status === 'submitted' ? 'bg-slate-100 text-slate-600' : 'bg-blue-600 text-white shadow-lg shadow-blue-100 active:scale-95'}">
                        ${isL5 ? '無需評核' : (status === 'submitted' ? '檢視評分' : '開始評核')} <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        let currentlyRatingEmpId = null;
        window.openEvaluation = (empId) => {
            currentlyRatingEmpId = empId;
            const emp = allUsers.find(u => u.id === empId);
            const rating = allRatings.find(r => r.employeeId === empId && r.supervisorId === currentUser.id && r.month === currentMonth);
            document.getElementById('supervisor-dashboard').classList.add('hidden');
            document.getElementById('evaluation-form-section').classList.remove('hidden');
            document.getElementById('eval-target-name').innerText = `${emp.name} (${emp.rank})`;
            const template = allTemplates[empId] || allTemplates['default'];
            renderEvaluationForm(rating, template);
        };

        function renderEvaluationForm(existingRating, template) {
            const formBody = document.getElementById('eval-form-body');
            formBody.innerHTML = '';
            const isReadonly = existingRating && existingRating.status === 'submitted';
            const sections = [{ label: '工作表現', key: 'work' }, { label: '綜合表現', key: 'general' }, { label: '個人學習', key: 'learning' }];

            sections.forEach(sec => {
                const categories = sec.key === 'learning' ? [template.learning] : template[sec.key];
                if (!categories || categories.length === 0) return;
                const h3 = document.createElement('h3');
                h3.className = "text-xl font-black text-blue-900 border-b-2 border-blue-50 pb-3 mb-6 mt-10";
                h3.innerText = sec.label;
                formBody.appendChild(h3);

                categories.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-6 rounded-3xl border border-slate-100 mb-6 shadow-sm";
                    div.innerHTML = `
                        <div class="font-black text-slate-800 mb-4 flex items-center gap-2">${cat.name || '項目'}</div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead><tr class="text-slate-400 border-b text-left text-xs uppercase tracking-widest font-black"><th class="pb-3">考核項目</th><th class="w-28 text-center pb-3">執行/準時</th><th class="w-28 text-center pb-3">品質/專業</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    `;
                    const tbody = div.querySelector('tbody');
                    cat.items.forEach(item => {
                        const s = (existingRating && existingRating.scores && existingRating.scores[item.id]) || { execution: '', quality: '' };
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-slate-50";
                        tr.innerHTML = `
                            <td class="py-4 font-bold text-slate-600">${item.name}</td>
                            <td class="px-2"><input type="number" step="0.1" min="0" max="5" ${isReadonly ? 'disabled' : ''} class="score-input w-full p-2 text-center bg-slate-50 rounded-xl font-black focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition-all" data-item="${item.id}" data-type="execution" value="${s.execution}"></td>
                            <td class="px-2"><input type="number" step="0.1" min="0" max="5" ${isReadonly ? 'disabled' : ''} class="score-input w-full p-2 text-center bg-slate-50 rounded-xl font-black focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition-all" data-item="${item.id}" data-type="quality" value="${s.quality}"></td>
                        `;
                        tbody.appendChild(tr);
                    });
                    formBody.appendChild(div);
                });
            });
            const commentArea = document.createElement('div');
            commentArea.className = "mt-10";
            commentArea.innerHTML = `<label class="block font-black text-slate-800 mb-3">綜合評語與建議</label><textarea id="eval-comment" ${isReadonly ? 'disabled' : ''} class="w-full p-5 border-2 border-slate-50 rounded-3xl h-40 outline-none focus:border-blue-500 bg-slate-50 focus:bg-white transition-all font-bold" placeholder="請在此輸入對該員工的觀察與改善建議...">${existingRating ? existingRating.comment : ''}</textarea>`;
            formBody.appendChild(commentArea);
            document.getElementById('eval-actions').innerHTML = isReadonly ? `<button onclick="closeEvaluation()" class="px-10 py-3 bg-slate-900 text-white rounded-2xl font-black shadow-xl active:scale-95 transition-all">關閉預覽</button>` : `<button onclick="submitRating('draft')" class="px-8 py-3 border-2 border-slate-100 rounded-2xl font-black text-slate-400 hover:bg-slate-50 transition-all">暫存</button><button onclick="submitRating('submitted')" class="px-8 py-3 bg-blue-600 text-white rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all active:scale-95">提交評核</button>`;
        }

        window.submitRating = async (status) => {
            if (status === 'submitted' && !confirm("確定送出？送出後將無法修改。")) return;
            const scores = {};
            document.querySelectorAll('.score-input').forEach(input => {
                const it = input.dataset.item;
                if (!scores[it]) scores[it] = {};
                scores[it][input.dataset.type] = input.value;
            });
            const rId = `${currentlyRatingEmpId}_${currentUser.id}_${currentMonth}`;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ratings', rId), {
                id: rId, employeeId: currentlyRatingEmpId, supervisorId: currentUser.id, supervisorName: currentUser.name,
                month: currentMonth, scores, comment: document.getElementById('eval-comment').value, status, updatedAt: new Date().toISOString()
            });
            showNotification(status === 'submitted' ? "考核表已正式送出" : "草稿儲存成功", "success");
            closeEvaluation();
        };

        window.closeEvaluation = () => {
            document.getElementById('supervisor-dashboard').classList.remove('hidden');
            document.getElementById('evaluation-form-section').classList.add('hidden');
        };

        // --- 管理後台 ---
        window.switchAdminTab = (tab) => {
            activeAdminTab = tab;
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('bg-white', 'shadow-sm', 'text-blue-600'));
            document.getElementById(`tab-btn-${tab}`).classList.add('bg-white', 'shadow-sm', 'text-blue-600');
            renderAdminTab();
        };

        function renderAdminTab() {
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`${activeAdminTab}-tab`).classList.remove('hidden');
            if (activeAdminTab === 'personnel') renderPersonnelTab();
            if (activeAdminTab === 'stats') renderStatsTab();
            if (activeAdminTab === 'charts') renderChartsTab();
            if (activeAdminTab === 'template') renderTemplateTab();
        }

        function renderPersonnelTab() {
            const tbody = document.getElementById('personnel-table-body');
            tbody.innerHTML = '';
            const sortedUsers = [...allUsers].sort((a,b) => (a.rank || '').localeCompare(b.rank || ''));
            sortedUsers.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-50 text-sm hover:bg-slate-50 transition-colors font-bold";
                const supervisorNames = (u.supervisorIds || []).map(sid => allUsers.find(s => s.id === sid)?.name || sid).join(', ');
                tr.innerHTML = `
                    <td class="p-5 font-black text-slate-800">${u.name}<br><span class="text-[9px] text-slate-300 font-bold tracking-widest uppercase">ID: ${u.id}</span></td>
                    <td class="p-5"><span class="px-3 py-1 rounded-full text-[10px] font-black tracking-wider ${u.type==='supervisor'?'bg-blue-50 text-blue-600':'bg-slate-50 text-slate-400'}">${u.type === 'supervisor' ? '評分主管' : '一般員工'}</span></td>
                    <td class="p-5 font-black text-blue-600">${u.rank || '-'}</td>
                    <td class="p-5 text-slate-400 font-medium text-xs max-w-[200px] truncate">${supervisorNames || '-'}</td>
                    <td class="p-5 text-right">
                        <button onclick="editUser('${u.id}')" class="text-blue-500 mr-2 p-2 hover:bg-blue-50 rounded-xl transition-all"><i data-lucide="settings" class="w-4 h-4"></i></button>
                        <button onclick="deleteUser('${u.id}')" class="text-red-400 p-2 hover:bg-red-50 rounded-xl transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        window.editUser = (uid) => {
            const user = allUsers.find(u => u.id === uid) || { id: '', name: '', password: '1234', type: 'employee', rank: 'L1', role: 'general', supervisorIds: [] };
            document.getElementById('user-modal').classList.remove('hidden');
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-id').disabled = !!uid;
            document.getElementById('user-name').value = user.name;
            document.getElementById('user-pass').value = user.password;
            document.getElementById('user-type').value = user.type;
            document.getElementById('user-rank').value = user.rank;
            document.getElementById('user-role').value = user.role;
            const sList = document.getElementById('supervisor-checkbox-list');
            sList.innerHTML = '';
            allUsers.filter(u => u.type === 'supervisor').forEach(s => {
                const isChecked = (user.supervisorIds || []).includes(s.id);
                const item = document.createElement('label');
                item.className = "flex items-center gap-3 p-3 hover:bg-white rounded-2xl cursor-pointer text-sm transition-all border border-transparent hover:border-slate-100";
                item.innerHTML = `<input type="checkbox" class="supervisor-checkbox w-4 h-4 rounded-full text-blue-600" value="${s.id}" ${isChecked ? 'checked' : ''}><div class="font-black text-slate-700">${s.name} <span class="text-[9px] text-slate-300 ml-1 font-bold tracking-widest">ID: ${s.id}</span></div>`;
                sList.appendChild(item);
            });
        };

        window.saveUser = async () => {
            const id = document.getElementById('user-id').value;
            if (!id) return showNotification("請輸入帳號 ID", "error");
            const selectedSupervisors = Array.from(document.querySelectorAll('.supervisor-checkbox:checked')).map(cb => cb.value);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), {
                id, name: document.getElementById('user-name').value, password: document.getElementById('user-pass').value,
                type: document.getElementById('user-type').value, rank: document.getElementById('user-rank').value,
                role: document.getElementById('user-role').value, supervisorIds: selectedSupervisors
            });
            document.getElementById('user-modal').classList.add('hidden');
            showNotification("人員資料儲存成功", "success");
        };

        window.deleteUser = async (uid) => {
            if (uid === 'Admin01') return showNotification("無法刪除預設管理員", "error");
            if (confirm("確定刪除此成員？")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid));
                showNotification("人員已移除", "success");
            }
        };

        // --- 模板編輯器 ---
        window.renderTemplateTab = () => {
            const container = document.getElementById('template-editor');
            container.innerHTML = '';
            const selectorDiv = document.createElement('div');
            selectorDiv.className = "mb-8 p-6 bg-white rounded-[2.5rem] border border-slate-100 flex flex-wrap items-center gap-6 shadow-sm";
            selectorDiv.innerHTML = `
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2 ml-1">設定對象：</label>
                    <select id="template-target-select" class="w-full p-4 border-2 border-slate-50 rounded-2xl font-black bg-slate-50 outline-none focus:bg-white focus:border-blue-500 transition-all text-slate-700" onchange="switchTemplateTarget(this.value)">
                        <option value="default" ${templateEditTargetId === 'default' ? 'selected' : ''}>[ 全公司共用模板 ]</option>
                        ${allUsers.filter(u => u.rank !== 'L5').map(u => `<option value="${u.id}" ${templateEditTargetId === u.id ? 'selected' : ''}>${u.name} 的個人考核表</option>`).join('')}
                    </select>
                </div>
                ${templateEditTargetId !== 'default' ? `<button onclick="resetToDefaultTemplate()" class="bg-red-50 text-red-600 px-8 py-4 rounded-2xl font-black text-xs hover:bg-red-100 transition-all">恢復公用模板</button>` : ''}
            `;
            container.appendChild(selectorDiv);

            const targetTemplate = allTemplates[templateEditTargetId] || allTemplates['default'];
            if (!targetTemplate) return;

            const createSection = (title, key) => {
                const section = document.createElement('div');
                section.className = "mb-10 bg-slate-50 p-8 rounded-[3rem] border border-slate-100 shadow-inner";
                section.innerHTML = `<div class="flex justify-between items-center mb-8"><h4 class="text-2xl font-black text-blue-900 tracking-tighter">${title}</h4>${key !== 'learning' ? `<button onclick="addTemplateCat('${key}')" class="text-[10px] bg-blue-600 text-white px-5 py-2 rounded-full font-black shadow-lg shadow-blue-100 active:scale-95 transition-all">+ 新增分類</button>` : ''}</div><div id="template-list-${key}"></div>`;
                container.appendChild(section);
                const list = section.querySelector(`#template-list-${key}`);
                const categories = key === 'learning' ? [targetTemplate.learning] : targetTemplate[key];
                categories.forEach((cat, cIdx) => {
                    if (!cat) return;
                    const catDiv = document.createElement('div');
                    catDiv.className = "bg-white p-6 rounded-[2rem] border border-slate-100 mb-5 shadow-sm";
                    catDiv.innerHTML = `
                        <div class="flex flex-wrap gap-4 mb-6 items-center">
                            <input type="text" class="flex-1 font-black border-b-2 border-slate-50 p-2 text-base outline-none focus:border-blue-500 transition-all" value="${cat.name || ''}" placeholder="類別名稱" onchange="updateTemplateVal('${key}', ${cIdx}, 'name', this.value)">
                            ${key !== 'learning' ? `<div class="flex items-center gap-2 text-[11px] font-black text-slate-400">權重%<input type="number" class="w-16 border-2 border-slate-50 rounded-xl p-2 text-center font-black text-slate-800 focus:border-blue-500" value="${cat.weight}" onchange="updateTemplateVal('${key}', ${cIdx}, 'weight', this.value)"></div><button onclick="deleteTemplateCat('${key}', ${cIdx})" class="text-slate-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : `<div class="flex items-center gap-2 text-[11px] font-black text-slate-400">總佔比%<input type="number" class="w-20 border-2 border-slate-50 rounded-xl p-2 text-center font-black text-slate-800 focus:border-blue-500" value="${cat.weight}" onchange="updateTemplateVal('${key}', ${cIdx}, 'weight', this.value)"></div>`}
                        </div>
                        <div class="pl-6 space-y-3" id="items-${key}-${cIdx}"></div>
                        <button onclick="addTemplateItem('${key}', ${cIdx})" class="text-[11px] text-blue-600 mt-6 font-black ml-6 hover:underline flex items-center gap-1 transition-all"><i data-lucide="plus" class="w-3 h-3"></i> 加入考核子項</button>
                    `;
                    const itemBox = catDiv.querySelector(`#items-${key}-${cIdx}`);
                    if (cat.items) cat.items.forEach((it, iIdx) => {
                        const itemRow = document.createElement('div');
                        itemRow.className = "flex gap-3 items-center group";
                        itemRow.innerHTML = `<input type="text" class="flex-1 text-xs bg-slate-50 p-3 rounded-2xl border-2 border-transparent outline-none focus:bg-white focus:border-blue-300 transition-all font-black text-slate-600" value="${it.name}" onchange="updateTemplateItem('${key}', ${cIdx}, ${iIdx}, this.value)"><button onclick="deleteTemplateItem('${key}', ${cIdx}, ${iIdx})" class="text-slate-200 group-hover:text-red-400 p-1 transition-colors">×</button>`;
                        itemBox.appendChild(itemRow);
                    });
                    list.appendChild(catDiv);
                });
            };
            createSection('工作表現', 'work'); createSection('綜合表現', 'general'); createSection('個人學習', 'learning');
            lucide.createIcons();
        };

        window.switchTemplateTarget = (id) => { templateEditTargetId = id; renderTemplateTab(); };
        window.resetToDefaultTemplate = async () => { if (confirm("確定恢復預設？")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'templates', templateEditTargetId)); showNotification("已恢復公用模板", "success"); } };
        window.updateTemplateVal = async (key, cIdx, field, val) => { const currentT = allTemplates[templateEditTargetId] || JSON.parse(JSON.stringify(allTemplates['default'])); if (key === 'learning') currentT.learning[field] = parseFloat(val); else currentT[key][cIdx][field] = field === 'weight' ? parseFloat(val) : val; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'templates', templateEditTargetId), currentT); };
        window.addTemplateCat = async (key) => { const currentT = allTemplates[templateEditTargetId] || JSON.parse(JSON.stringify(allTemplates['default'])); currentT[key].push({ id: `c_${Date.now()}`, name: "新分類", weight: 0, items: [{ id: `i_${Date.now()}`, name: "新項目" }] }); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'templates', templateEditTargetId), currentT); };
        window.deleteTemplateCat = async (key, cIdx) => { const currentT = allTemplates[templateEditTargetId] || JSON.parse(JSON.stringify(allTemplates['default'])); currentT[key].splice(cIdx, 1); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'templates', templateEditTargetId), currentT); };
        window.addTemplateItem = async (key, cIdx) => { const currentT = allTemplates[templateEditTargetId] || JSON.parse(JSON.stringify(allTemplates['default'])); const target = key === 'learning' ? currentT.learning : currentT[key][cIdx]; if (!target.items) target.items = []; target.items.push({ id: `i_${Date.now()}`, name: "新項目" }); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'templates', templateEditTargetId), currentT); };
        window.updateTemplateItem = async (key, cIdx, iIdx, val) => { const currentT = allTemplates[templateEditTargetId] || JSON.parse(JSON.stringify(allTemplates['default'])); const target = key === 'learning' ? currentT.learning : currentT[key][cIdx]; target.items[iIdx].name = val; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'templates', templateEditTargetId), currentT); };
        window.deleteTemplateItem = async (key, cIdx, iIdx) => { const currentT = allTemplates[templateEditTargetId] || JSON.parse(JSON.stringify(allTemplates['default'])); const target = key === 'learning' ? currentT.learning : currentT[key][cIdx]; target.items.splice(iIdx, 1); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'templates', templateEditTargetId), currentT); };

        // --- 統計計算 ---
        function calculateFinalScore(empId, month) {
            const template = allTemplates[empId] || allTemplates['default'];
            if (!template) return null;
            const ratings = allRatings.filter(r => r.employeeId === empId && r.month === month && r.status === 'submitted');
            if (ratings.length === 0) return null;
            const getAvg = (itemId) => { let s = 0, c = 0; ratings.forEach(r => { const it = r.scores && r.scores[itemId]; if (it && it.execution && it.quality) { s += (parseFloat(it.execution) + parseFloat(it.quality)) / 2; c++; } }); return c > 0 ? s / c : null; };
            const processGroup = (group) => { let totalW = 0, active = []; group.forEach(cat => { let cs = 0, cc = 0; if (cat.items) cat.items.forEach(it => { const a = getAvg(it.id); if (a!==null) { cs+=a; cc++; } }); if (cc>0) { active.push({ s: (cs/cc/5)*100, w: cat.weight }); totalW += cat.weight; } }); if (totalW === 0) return 0; return active.reduce((acc, c) => acc + (c.s * (c.w / 100) * (100 / totalW)), 0); };
            const work = processGroup(template.work); const general = processGroup(template.general);
            let ls = 0, lc = 0; if (template.learning && template.learning.items) template.learning.items.forEach(it => { const a = getAvg(it.id); if (a!==null) { ls+=a; lc++; } });
            const learning = lc > 0 ? (ls / lc / 5) * 100 : 0; const lw = (template.learning?.weight || 0) / 100;
            return { work, general, learning, total: (work + general) / 2 * (1 - lw) + (learning * lw) };
        }

        function renderStatsTab() {
            const container = document.getElementById('stats-container'); container.innerHTML = '';
            const prevDate = new Date(); prevDate.setMonth(prevDate.getMonth()-1); const prevStr = `${prevDate.getFullYear()}-${String(prevDate.getMonth()+1).padStart(2,'0')}`;
            allUsers.filter(u => u.rank !== 'L5').forEach(emp => {
                const cur = calculateFinalScore(emp.id, currentMonth); const pre = calculateFinalScore(emp.id, prevStr);
                const diff = cur && pre ? cur.total - pre.total : null;
                const card = document.createElement('div'); card.className = "bg-white p-8 rounded-[2.5rem] border border-slate-100 mb-6 shadow-sm";
                card.innerHTML = `<div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-3"><div><h4 class="font-black text-xl text-slate-800 tracking-tight">${emp.name} <span class="text-[9px] font-black text-slate-300 ml-1 tracking-widest uppercase">Rank ${emp.rank}</span></h4></div><div class="flex flex-wrap gap-2" id="retract-${emp.id}"></div></div><div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center text-sm font-black"><div class="p-4 bg-slate-50 rounded-3xl shadow-inner"><div class="text-[9px] text-slate-400 mb-2 uppercase tracking-tighter">Work</div><div class="text-slate-800">${cur?cur.work.toFixed(1):'-'}</div></div><div class="p-4 bg-slate-50 rounded-3xl shadow-inner"><div class="text-[9px] text-slate-400 mb-2 uppercase tracking-tighter">General</div><div class="text-slate-800">${cur?cur.general.toFixed(1):'-'}</div></div><div class="p-4 bg-slate-50 rounded-3xl shadow-inner"><div class="text-[9px] text-slate-400 mb-2 uppercase tracking-tighter">Learning</div><div class="text-slate-800">${cur?cur.learning.toFixed(1):'-'}</div></div><div class="p-4 bg-blue-50 rounded-3xl text-blue-600 border border-blue-100"><div class="text-[9px] text-blue-400 mb-2 uppercase tracking-tighter">Monthly Final</div><div class="text-2xl font-black">${cur?cur.total.toFixed(1):'-'}</div></div><div class="p-4 bg-slate-50 rounded-3xl shadow-inner"><div class="text-[9px] text-slate-400 mb-2 uppercase tracking-tighter">Growth</div><div class="${getDiffColor(diff)}">${diff !== null ? (diff>0?'+':'')+diff.toFixed(1) : 'NEW'}</div></div></div>`;
                container.appendChild(card);
                allRatings.filter(r => r.employeeId === emp.id && r.month === currentMonth && r.status === 'submitted').forEach(r => {
                    const b = document.createElement('button'); b.className = "text-[9px] bg-red-50 text-red-600 px-3 py-1.5 rounded-full border-2 border-red-50 hover:bg-red-100 transition-all font-black uppercase"; b.innerText = `Retract ${r.supervisorName}`;
                    b.onclick = async () => { if(confirm(`退回 ${r.supervisorName} 的評核記錄？`)) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ratings', r.id), {status:'draft'}); showNotification("已成功退回至暫存狀態","success"); } };
                    document.getElementById(`retract-${emp.id}`).appendChild(b);
                });
            });
        }

        function getDiffColor(v) { if(v===null)return"text-slate-300"; if(v>=5)return"text-green-600"; if(v<=-6)return"text-red-600"; if(v<0)return"text-orange-500"; return"text-slate-600"; }

        let activeCharts = [];
        function renderChartsTab() {
            const container = document.getElementById('charts-container'); container.innerHTML = '';
            activeCharts.forEach(c => c.destroy()); activeCharts = [];
            RANKS.filter(r => r !== 'L5').forEach(rank => {
                const emps = allUsers.filter(u => u.rank === rank); if (emps.length === 0) return;
                const wrapper = document.createElement('div'); wrapper.className = "bg-white p-10 rounded-[3rem] border border-slate-100 mb-12 shadow-sm";
                wrapper.innerHTML = `<h3 class="font-black text-slate-800 mb-8 flex items-center gap-3 tracking-tighter text-2xl"><i data-lucide="bar-chart-3" class="w-6 h-6 text-blue-600"></i> ${rank} 職等考核趨勢</h3><div class="h-[400px]"><canvas id="c-${rank}"></canvas></div>`;
                container.appendChild(wrapper);
                const ctx = document.getElementById(`c-${rank}`).getContext('2d');
                const datasets = emps.map((emp, i) => {
                    const data = []; for(let m=1; m<=12; m++) { const mStr = `${new Date().getFullYear()}-${String(m).padStart(2,'0')}`; const res = calculateFinalScore(emp.id, mStr); data.push(res ? res.total : 0); }
                    return { label: emp.name, data, backgroundColor: `hsla(${i * 60}, 80%, 50%, 0.8)`, borderRadius: 8, barThickness: 15 };
                });
                const chart = new Chart(ctx, { type: 'bar', data: { labels: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'], datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { weight: 'bold' } } } }, scales: { y: { beginAtZero: true, max: 100, grid: { color: '#f8fafc' }, ticks: { font: { weight: 'bold' } } }, x: { grid: { display: false }, ticks: { font: { weight: 'bold' } } } } } });
                activeCharts.push(chart);
            });
            lucide.createIcons();
        }

        window.exportCSV = () => {
            const headers = ["月份", "員工姓名", "職等", "主管姓名", "細項項目", "平均分", "總分", "評語"];
            const rows = allRatings.filter(r => r.status === 'submitted').flatMap(r => {
                const emp = allUsers.find(u => u.id === r.employeeId);
                const final = calculateFinalScore(r.employeeId, r.month);
                return Object.entries(r.scores).map(([itId, val]) => [r.month, emp?.name || r.employeeId, emp?.rank || '-', r.supervisorName, itId, (parseFloat(val.execution)+parseFloat(val.quality))/2, final?.total.toFixed(1) || '-', (r.comment || '').replace(/,/g, '，').replace(/\n/g, ' ')]);
            });
            const content = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(",") + "\n" + rows.map(r => r.join(",")).join("\n");
            const link = document.createElement("a"); link.href = encodeURI(content); link.download = `年度考核全彙整_${currentMonth}.csv`; link.click();
        };

        function showNotification(msg, type) { const n = document.getElementById('notification'); if (!n) return; n.innerText = msg; n.className = `fixed bottom-8 right-8 px-8 py-4 rounded-3xl text-white font-black transition-all transform z-[60] shadow-2xl tracking-tighter ${type==='success'?'bg-slate-900 border-b-4 border-blue-500':'bg-red-600 border-b-4 border-red-800'}`; n.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => { n.classList.add('translate-y-20', 'opacity-0'); }, 3500); }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; letter-spacing: -0.01em; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased font-sans selection:bg-blue-100">
    
    <!-- 載入層 -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center text-center p-4 transition-all duration-500">
        <div class="w-16 h-16 border-[6px] border-blue-600 border-t-transparent rounded-full animate-spin mb-8"></div>
        <p class="text-slate-300 font-black tracking-[0.3em] text-xs uppercase">Syncing Cloud Database</p>
    </div>

    <!-- 導航欄 -->
    <nav id="main-nav" class="hidden fixed top-0 left-0 right-0 bg-white/70 backdrop-blur-2xl border-b z-40 px-8 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-4">
            <div class="bg-blue-600 p-2.5 rounded-2xl shadow-xl shadow-blue-100 transform rotate-3"><i data-lucide="shield-check" class="w-5 h-5 text-white"></i></div>
            <div><span class="font-black text-slate-900 block leading-none tracking-tighter text-lg">員工績效考核</span><span class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-1 current-month-text"></span></div>
        </div>
        <div class="flex items-center gap-8">
            <div class="text-right">
                <div id="user-name-display" class="text-sm font-black text-slate-800"></div>
                <button id="admin-toggle-btn" onclick="toggleAdminView()" class="hidden text-[10px] text-blue-600 font-black hover:text-blue-800 transition-all tracking-widest mt-1 underline decoration-2 underline-offset-4"></button>
            </div>
            <button onclick="location.reload()" class="p-3 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-2xl transition-all"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>
    </nav>

    <!-- 登入頁 -->
    <section id="login-view" class="view-section min-h-screen flex items-center justify-center p-6 bg-slate-50">
        <div class="max-w-md w-full bg-white rounded-[3rem] shadow-2xl p-12 border border-slate-100">
            <div class="text-center mb-12">
                <div class="bg-blue-600 w-24 h-24 rounded-[2rem] flex items-center justify-center mx-auto mb-8 text-white shadow-2xl shadow-blue-100 transform -rotate-12"><i data-lucide="award" class="w-12 h-12"></i></div>
                <h1 class="text-5xl font-black text-slate-900 tracking-tighter mb-3">Login</h1>
                <p class="text-slate-400 font-bold tracking-tight">請選取您的帳號並輸入登入密碼</p>
            </div>
            <div class="space-y-6">
                <div><label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-[0.2em]">Supervisor Account</label><select id="login-user-select" class="w-full p-5 border-4 border-slate-50 rounded-3xl bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition-all font-black text-slate-700"></select></div>
                <div><label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-[0.2em]">Password</label><input id="login-password" type="password" class="w-full p-5 border-4 border-slate-50 rounded-3xl bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition-all font-black" placeholder="••••••••"></div>
                <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-6 rounded-3xl shadow-2xl shadow-blue-100 transition-all active:scale-95 text-xl tracking-tighter mt-4">進入系統</button>
            </div>
        </div>
    </section>

    <!-- 主管端 -->
    <section id="supervisor-view" class="view-section hidden pt-32 pb-12 px-8 max-w-7xl mx-auto">
        <div id="supervisor-dashboard">
            <div class="mb-12 flex flex-col md:flex-row justify-between md:items-end gap-6 border-b-2 border-slate-100 pb-10"><div class="max-w-2xl"><h2 class="text-5xl font-black text-slate-900 tracking-tighter mb-2">考核名單</h2><p class="text-slate-400 font-bold text-lg">系統已過濾出本月需受評之對象，請在截止日前完成評分作業。</p></div><div class="bg-blue-600 px-6 py-3 rounded-2xl text-white font-black text-xs shadow-xl shadow-blue-100"><span class="current-month-text"></span> 考核週期</div></div>
            <div id="employee-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></div>
        </div>
        <div id="evaluation-form-section" class="hidden max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-10 bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                <button onclick="closeEvaluation()" class="flex items-center text-slate-400 font-black hover:text-blue-600 px-6 py-3 hover:bg-slate-50 rounded-2xl transition-all gap-2"><i data-lucide="arrow-left" class="w-5 h-5"></i> 返回清單</button>
                <h2 class="text-2xl font-black text-slate-800 tracking-tight" id="eval-target-name"></h2>
                <div class="flex gap-3" id="eval-actions"></div>
            </div>
            <div id="eval-form-body" class="bg-white p-10 md:p-16 rounded-[4rem] border border-slate-100 shadow-2xl mb-24"></div>
        </div>
    </section>

    <!-- 管理端 -->
    <section id="admin-view" class="view-section hidden pt-32 pb-12">
        <div class="max-w-7xl mx-auto px-8">
            <div class="flex flex-wrap gap-3 bg-slate-200/40 p-3 rounded-[2rem] mb-12 w-fit">
                <button id="tab-btn-personnel" onclick="switchAdminTab('personnel')" class="admin-tab-btn px-8 py-4 rounded-2xl text-sm font-black transition-all bg-white shadow-sm text-blue-600">人員維護</button>
                <button id="tab-btn-stats" onclick="switchAdminTab('stats')" class="admin-tab-btn px-8 py-4 rounded-2xl text-sm font-black transition-all">績效總表</button>
                <button id="tab-btn-charts" onclick="switchAdminTab('charts')" class="admin-tab-btn px-8 py-4 rounded-2xl text-sm font-black transition-all">分析趨勢</button>
                <button id="tab-btn-template" onclick="switchAdminTab('template')" class="admin-tab-btn px-8 py-4 rounded-2xl text-sm font-black transition-all">模板客製</button>
            </div>

            <div id="personnel-tab" class="admin-tab-content">
                <div class="flex justify-between items-center mb-10"><h3 class="text-3xl font-black text-slate-800 tracking-tighter">公司成員</h3><button onclick="editUser()" class="bg-blue-600 text-white px-10 py-4 rounded-3xl font-black shadow-2xl shadow-blue-100 hover:bg-blue-700 transition-all active:scale-95">+ 新增成員</button></div>
                <div class="bg-white rounded-[3rem] border border-slate-100 overflow-hidden shadow-sm font-bold"><table class="w-full text-left"><thead class="bg-slate-50 text-slate-300 text-[10px] uppercase font-black tracking-[0.2em]"><tr><th class="p-6">姓名與 ID</th><th class="p-6">角色屬性</th><th class="p-6">職等編碼</th><th class="p-6">指定評分主管</th><th class="p-6 text-right">管理操作</th></tr></thead><tbody id="personnel-table-body"></tbody></table></div>
            </div>

            <div id="stats-tab" class="admin-tab-content hidden"><div class="flex justify-between items-center mb-10"><div><h3 class="text-3xl font-black text-slate-800 tracking-tighter">考核統計</h3><p class="text-slate-400 font-bold mt-1 uppercase text-xs tracking-widest current-month-text"></p></div><button onclick="exportCSV()" class="bg-slate-900 text-white px-8 py-4 rounded-2xl text-sm font-black flex items-center gap-3 hover:bg-black shadow-xl transition-all"><i data-lucide="download" class="w-4 h-4 text-blue-400"></i> 下載 Excel 報表</button></div><div id="stats-container" class="grid grid-cols-1 gap-6"></div></div>

            <div id="charts-tab" class="admin-tab-content hidden"><h3 class="text-3xl font-black text-slate-800 mb-12 tracking-tighter">年度績效對比</h3><div id="charts-container" class="space-y-12"></div></div>

            <div id="template-tab" class="admin-tab-content hidden"><div id="template-editor"></div></div>
        </div>
    </section>

    <!-- Modal -->
    <div id="user-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md z-50 flex items-center justify-center p-6">
        <div class="bg-white rounded-[3.5rem] p-12 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto border border-slate-100 font-bold">
            <h3 class="text-4xl font-black mb-10 text-slate-900 tracking-tighter">成員設定</h3>
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-6">
                    <div><label class="text-[10px] font-black text-slate-300 block mb-2 uppercase tracking-widest">ID</label><input id="user-id" class="w-full p-4 border-4 border-slate-50 rounded-[1.5rem] bg-slate-50 outline-none focus:bg-white focus:border-blue-500 transition-all font-black"></div>
                    <div><label class="text-[10px] font-black text-slate-300 block mb-2 uppercase tracking-widest">姓名</label><input id="user-name" class="w-full p-4 border-4 border-slate-50 rounded-[1.5rem] bg-slate-50 outline-none focus:bg-white focus:border-blue-500 transition-all font-black"></div>
                </div>
                <div><label class="text-[10px] font-black text-slate-300 block mb-2 uppercase tracking-widest">登入密碼</label><input id="user-pass" class="w-full p-4 border-4 border-slate-50 rounded-[1.5rem] bg-slate-50 outline-none focus:bg-white focus:border-blue-500 transition-all font-black"></div>
                <div class="grid grid-cols-2 gap-6">
                    <div><label class="text-[10px] font-black text-slate-300 block mb-2 uppercase tracking-widest">類型</label><select id="user-type" class="w-full p-4 border-4 border-slate-50 rounded-[1.5rem] bg-slate-50 focus:bg-white outline-none font-black text-slate-700"><option value="employee">一般員工</option><option value="supervisor">評分主管</option></select></div>
                    <div><label class="text-[10px] font-black text-slate-300 block mb-2 uppercase tracking-widest">薪資職等</label><select id="user-rank" class="w-full p-4 border-4 border-slate-50 rounded-[1.5rem] bg-slate-50 focus:bg-white outline-none font-black text-slate-700"><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5 (非受評者)</option></select></div>
                </div>
                <div><label class="text-[10px] font-black text-slate-300 block mb-2 uppercase tracking-widest">管理後台</label><select id="user-role" class="w-full p-4 border-4 border-slate-50 rounded-[1.5rem] bg-slate-50 focus:bg-white outline-none font-black text-slate-700"><option value="general">僅能評分</option><option value="admin">管理者權限</option></select></div>
                <div><label class="text-[10px] font-black text-slate-300 block mb-2 uppercase tracking-widest">指派多位主管</label><div id="supervisor-checkbox-list" class="border-4 border-slate-50 rounded-[2rem] p-5 bg-slate-50 max-h-56 overflow-y-auto space-y-3 shadow-inner"></div></div>
                <div class="flex gap-4 pt-8"><button onclick="document.getElementById('user-modal').classList.add('hidden')" class="flex-1 py-5 border-4 border-slate-50 rounded-[1.5rem] font-black text-slate-300 hover:bg-slate-50 transition-all">取消</button><button onclick="saveUser()" class="flex-1 py-5 bg-blue-600 text-white rounded-[1.5rem] font-black shadow-2xl shadow-blue-100 hover:bg-blue-700 transition-all active:scale-95">儲存</button></div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="fixed bottom-10 right-10 translate-y-20 opacity-0 transition-all duration-500 z-[60] pointer-events-none"></div>

</body>
</html>